<HTML>
<head>
<script type="text/javascript">
function keysInObject(o) {
  keys = [];

  for (key in o) {
    keys.push(key);
  }

  return keys;
}

function longestString(ss) {
  longest = '';

  for (i = 0; i < ss.length; i++) {
    if (ss[i].length > longest.length) {
      longest = ss[i];
    }
  }

  return longest;
}

function buildConfidenceGrid(confidences) {
  width = 20
  decimals = 5
  names = keysInObject(confidences);
  nameLength = longestString(names).length;

  confidenceGridHtml = '<code><pre>';

  for (i = 0; i < names.length; i++) {
    name = names[i]

    // format the name with trailing spaces
    numSpaces = nameLength - name.length + 1;
    spaces = ' '.repeat(numSpaces);
    confidence = confidences[name];

    // format the chart (stars) with trailing spaces
    gConfidence = Math.round(confidence * width);
    gStars = '*'.repeat(gConfidence);
    gSpaces = ' '.repeat(width - gConfidence);
    gBar = '  [' + gStars + gSpaces + ']'

    confidenceGridHtml += name + spaces + confidence.toFixed(decimals) + gBar + '<br/>';
  }

  confidenceGridHtml += '</pre></code>';

  return confidenceGridHtml
}

function keyWithGreatestValue(o) {
  greatestValueKey = o[0];
  greatestValue = 0.0;

  for (key in o) {
    if (o[key] > greatestValue) {
      greatestValueKey = key;
      greatestValue = o[key];
    }
  }

  return greatestValueKey;
}

function buildLanguageSelectOptions(languageSelect, names) {
  while (languageSelect.firstChild) {
    languageSelect.removeChild(languageSelect.firstChild);
  }

  for (i = 0; i < names.length; i++) {
    option = document.createElement('option');
    option.value = names[i]
    option.textContent = names[i];
    languageSelect.appendChild(option);
  }
}

function loadLanguageNames() {
  var languageSelect = document.getElementById('language');

  while (languageSelect.firstChild) {
    languageSelect.removeChild(languageSelect.firstChild);
  }

  var code = document.getElementById('code').value;
  var req = new XMLHttpRequest();
  req.open('GET', "/languages", true);

  req.onload = function (e) {
    if (req.readyState === 4) {
      if (req.status === 200) {
        results = req.responseText;
        names = JSON.parse(results);
        names.sort();

        for (i = 0; i < names.length; i++) {
          option = document.createElement('option');
          option.value = names[i]
          option.textContent = names[i];
          languageSelect.appendChild(option);
        }
      }
    }
  }

  req.send()
}

function detectLanguage() {
    var results = '';
    var code = document.getElementById('code').value;
    var req = new XMLHttpRequest();
    req.open('POST', "/detect", true);
    req.setRequestHeader("Content-type", "text/plain");

    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          confidences = JSON.parse(results);
          names = keysInObject(confidences).sort();

          // build list of names
          var languageSelect = document.getElementById('language');
          buildLanguageSelectOptions(languageSelect, names)

          // build list of names and confidence values
          var detectDiv = document.getElementById('detect_result');
          confidenceGridHtml = buildConfidenceGrid(confidences);
          detectDiv.innerHTML = confidenceGridHtml;

          if (names.length > 0) {
            // find the most likely language
            languageSelect.value = keyWithGreatestValue(confidences)
          }
        } else {
          console.error(req.statusText);
        }
      }
    };

    req.onerror = function (e) {
      console.error(req.statusText);
    };

    req.send(code);
}

function textToSafeHtml(str) {
  s1 = str.replace(/&/g, '&amp;');
  s2 = s1.replace(/</g, '&lt;');
  s3 = s2.replace(/>/g, '&gt;');
  s4 = s3.replace(/"/g, '&quot;');
  return s4;
}

function colorize(token, htmlColors) {
  tokenType = token['type'];
  tokenValue = token['value'];
  tokenSafe = textToSafeHtml(tokenValue);
  tokenHtml = 'empty';

  if (tokenType == 'newline') {
    tokenHtml = '<br/>'; 
  } else if (tokenType.startsWith('invalid')) {
    frontHtml = '<font color=red>';
    backHtml = '</font>';
    tokenHtml = frontHtml + tokenSafe + backHtml;
  } else if (tokenType in htmlColors) {
    frontHtml = '<font color=' + htmlColors[tokenType] + '>';
    backHtml = '</font>';
    tokenHtml = frontHtml + tokenSafe + backHtml;
  } else {
    tokenHtml = tokenSafe;
  }

  return tokenHtml;
}

function tokenize() {
    htmlColors = {
      keyword: 'orchid',
      number: 'blue',
      string: 'salmon',
      operator: 'green',
      format: 'orange',
      comment: 'yellowgreen',
      remark: 'yellowgreen',
      picture: 'hotpink',
      invalid: 'red',
      preprocessor: 'lightgreen',
      'line number': 'skyblue',
      'line identification': 'royalblue',
      'line continuation': 'goldenrod'
    };

    var results = '';
    var code = document.getElementById('code').value;
    var language = document.getElementById('language').value;
    // change 'C++' because the '+' character causes problems for requests
    // TODO: escape the request to allow '+'
    if (language == 'C++') {
      language = 'Cpp';
    }

    var query = "/tokens?language=" + language;
    var req = new XMLHttpRequest();
    req.open('POST', query, true);
    req.setRequestHeader("Content-type", "text/plain");
    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          data = JSON.parse(results)
          formattedResults = '<code><pre>';
          length = data.length;

          for (i = 0; i < length; i++) {
            formattedResults += colorize(data[i], htmlColors)
          }

          formattedResults += '</pre></code>'

          var div = document.getElementById('tokens_result');
          div.innerHTML = formattedResults;
        } else {
          // TODO: build a response
          console.error(req.statusText);
        }
      }
    };

    req.onerror = function (e) {
      // TODO: build a response
      console.error(req.statusText);
    };

    req.send(code);
}
</script>
</head>
<body onload="loadLanguageNames()">
Welcome to the CodeStat page!
<textarea style="width:100%;" rows="20" id="code"></textarea>
<br/>
<input type="button" OnClick="detectLanguage();" value="Detect language"/>
<br/>
<select name="language" id="language">
<option>BASIC</option>
</select>
<input type="button" OnClick="tokenize();" value="Tokenize"/>
<div id="detect_result" style="border:1px solid black"></div>
<div id="confidence_result" style="border:1px solid black"></div>
<div id="tokens_result" style="border:1px solid black"></div>
</body>
</HTML>
