<HTML>
<head>
<script type="text/javascript">
function keysInObject(o) {
  keys = [];

  for (key in o) {
    keys.push(key);
  }

  return keys;
}

function longestString(ss) {
  longest = '';

  for (i = 0; i < ss.length; i++) {
    if (ss[i].length > longest.length) {
      longest = ss[i];
    }
  }

  return longest;
}

function buildConfidenceGrid(confidences) {
  width = 20
  decimals = 5
  names = keysInObject(confidences);
  nameLength = longestString(names).length;

  confidenceGridHtml = '<code><pre>';

  for (i = 0; i < names.length; i++) {
    name = names[i]

    // format the name with trailing spaces
    numSpaces = nameLength - name.length + 1;
    spaces = ' '.repeat(numSpaces);
    confidence = confidences[name];

    // format the chart (stars) with trailing spaces
    gConfidence = Math.round(confidence * width);
    gStars = '*'.repeat(gConfidence);
    gSpaces = ' '.repeat(width - gConfidence);
    gBar = '  [' + gStars + gSpaces + ']'

    confidenceGridHtml += name + spaces + confidence.toFixed(decimals) + gBar + '<br/>';
  }

  confidenceGridHtml += '</pre></code>';

  return confidenceGridHtml
}

function keyWithGreatestValue(o) {
  greatestValueKey = o[0];
  greatestValue = 0.0;

  for (key in o) {
    if (o[key] > greatestValue) {
      greatestValueKey = key;
      greatestValue = o[key];
    }
  }

  return greatestValueKey;
}

function buildLanguageSelectOptions(languageSelect, names) {
  while (languageSelect.firstChild) {
    languageSelect.removeChild(languageSelect.firstChild);
  }

  for (i = 0; i < names.length; i++) {
    option = document.createElement('option');
    option.value = names[i]
    option.textContent = names[i];
    languageSelect.appendChild(option);
  }
}

function loadLanguageNames() {
  var languageSelect = document.getElementById('language');

  while (languageSelect.firstChild) {
    languageSelect.removeChild(languageSelect.firstChild);
  }

  var code = document.getElementById('code').value;
  var req = new XMLHttpRequest();
  req.open('GET', "/languages", true);

  req.onload = function (e) {
    if (req.readyState === 4) {
      if (req.status === 200) {
        results = req.responseText;
        names = JSON.parse(results);
        names.sort();

        for (i = 0; i < names.length; i++) {
          option = document.createElement('option');
          option.value = names[i]
          option.textContent = names[i];
          languageSelect.appendChild(option);
        }
      }
    }
  }

  req.send()
}

function detectLanguage() {
    var results = '';
    var code = document.getElementById('code').value;
    var req = new XMLHttpRequest();
    req.open('POST', "/detect", true);
    req.setRequestHeader("Content-type", "text/plain");

    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          confidences = JSON.parse(results);
          names = keysInObject(confidences).sort();

          // build list of names
          var languageSelect = document.getElementById('language');
          buildLanguageSelectOptions(languageSelect, names)

          // build list of names and confidence values
          var detectDiv = document.getElementById('detect_result');
          confidenceGridHtml = buildConfidenceGrid(confidences);
          detectDiv.innerHTML = confidenceGridHtml;

          if (names.length > 0) {
            // find the most likely language
            languageSelect.value = keyWithGreatestValue(confidences)
          }
        } else {
          console.error(req.statusText);
        }
      }
    };

    req.onerror = function (e) {
      console.error(req.statusText);
    };

    req.send(code);
}

function textToSafeHtml(str) {
  s1 = str.replace(/&/g, '&amp;');
  s2 = s1.replace(/</g, '&lt;');
  s3 = s2.replace(/>/g, '&gt;');
  s4 = s3.replace(/"/g, '&quot;');
  return s4;
}

function colorize(token, htmlColors) {
  tokenType = token['type'];
  tokenValue = token['value'];
  tokenSafe = textToSafeHtml(tokenValue);
  tokenHtml = 'empty';

  if (tokenType == 'newline') {
    tokenHtml = '<br/>'; 
  } else if (tokenType.startsWith('invalid')) {
    frontHtml = '<font color=red>';
    backHtml = '</font>';
    tokenHtml = frontHtml + tokenSafe + backHtml;
  } else if (tokenType in htmlColors) {
    frontHtml = '<font color=' + htmlColors[tokenType] + '>';
    backHtml = '</font>';
    tokenHtml = frontHtml + tokenSafe + backHtml;
  } else {
    tokenHtml = tokenSafe;
  }

  return tokenHtml;
}

function formatCounts(counts) {
  html = ''

  var keys = [];
  for (var key in counts) {
    if (counts.hasOwnProperty(key)) {
      keys.push(key);
    }
  }
  length = keys.length

  total = 0
  for (i = 0; i < length; i++) {
    key = keys[i];
    count = counts[key];
    total += count
    html += key + '|' + count + '<br/>';
  }
  html += 'TOTAL' + '|' + total + '<br/>';

  return html;
}

function formatConfidence(confidences) {
  html = ''

  var keys = [];
  for (var key in confidences) {
    if (confidences.hasOwnProperty(key)) {
      keys.push(key);
    }
  }
  length = keys.length

  for (i = 0; i < length; i++) {
    key = keys[i];
    count = confidences[key];
    html += key + '|' + count + '<br/>';
  }

  return html;
}

function showConfidence() {
  var results = '';
  var code = document.getElementById('code').value;
  var language = document.getElementById('language').value;
  // change 'C++' because the '+' character causes problems for requests
  // TODO: escape the request to allow '+'
  if (language == 'C++') {
    language = 'Cpp';
  }
  if (language == 'C#') {
    language = 'Csharp';
  }

  var query = "/confidence?language=" + language;
  var req = new XMLHttpRequest();
  req.open('POST', query, true);
  req.setRequestHeader("Content-type", "text/plain");
  req.onload = function (e) {
    if (req.readyState === 4) {
      if (req.status === 200) {
        results = req.responseText;
        confidences = JSON.parse(results);
        length = confidences.length;

        formattedConfidence = formatConfidence(confidences);

        var div_confidence = document.getElementById('confidence_result');
        div_confidence.innerHTML = formattedConfidence;
      } else {
        // TODO: build a response
        console.error(req.statusText);
      }
    }
  };

  req.onerror = function (e) {
    // TODO: build a response
    console.error(req.statusText);
  };

  req.send(code);
};

function tokenize() {
  htmlColors = {
    keyword: 'orchid',
    number: 'blue',
    string: 'salmon',
    variable: 'steelblue',
    symbol: 'purple',
    operator: 'green',
    format: 'orange',
    comment: 'yellowgreen',
    remark: 'yellowgreen',
    picture: 'hotpink',
    invalid: 'red',
    preprocessor: 'lightgreen',
    attribute: 'lightgreen',
    'line number': 'skyblue',
    'line identification': 'royalblue',
    'line continuation': 'goldenrod',
    'statement separator': 'goldenrod',
    'doc marker': 'orchid',
    'here doc': 'hotpink'
  };

  var results = '';
  var code = document.getElementById('code').value;
  var language = document.getElementById('language').value;
  // change 'C++' because the '+' character causes problems for requests
  // TODO: escape the request to allow '+'
  if (language == 'C++') {
    language = 'Cpp';
  }
  if (language == 'C#') {
    language = 'Csharp';
  }

  var query = "/tokens?language=" + language;
  var req = new XMLHttpRequest();
  req.open('POST', query, true);
  req.setRequestHeader("Content-type", "text/plain");
  req.onload = function (e) {
    if (req.readyState === 4) {
      if (req.status === 200) {
        results = req.responseText;
        tokens = JSON.parse(results);
        length = tokens.length;

        counts = {};

        for (i = 0; i < length; i++) {
          token = tokens[i];
          ctype = token['type'];
          if (ctype in counts) {
            counts[ctype] += 1;
          } else {
            counts[ctype] = 1;
          }
        }

        formattedDetails = formatCounts(counts);

        var div_details = document.getElementById('tokens_details');
        div_details.innerHTML = formattedDetails;

        formattedResults = '<code><pre>';

        length = tokens.length;

        for (i = 0; i < length; i++) {
          token = tokens[i];
          formattedResults += colorize(token, htmlColors);
        }

        formattedResults += '</pre></code>';

        var div_tokens = document.getElementById('tokens_result');
        div_tokens.innerHTML = formattedResults;
      } else {
        // TODO: build a response
        console.error(req.statusText);
      }
    }
  };

  req.onerror = function (e) {
    // TODO: build a response
    console.error(req.statusText);
  };

  req.send(code);
}
</script>
</head>
<body onload="loadLanguageNames()">
Welcome to the CodeStat page!
<textarea style="width:100%;" rows="20" id="code"></textarea>
<br/>
<input type="button" OnClick="detectLanguage();" value="Detect language"/>
<br/>
<select name="language" id="language">
<option>BASIC</option>
</select>
<input type="button" OnClick="tokenize();" value="Tokenize"/>
<input type="button" OnClick="showConfidence();" value="Confidence"/>
<div id="detect_result" style="border:1px solid black"></div>
<div id="confidence_result" style="border:1px solid black"></div>
<div id="tokens_details" style="border:1px solid black"></div>
<div id="tokens_result" style="border:1px solid black"></div>
</body>
</HTML>
