<HTML>
<head>
<script type="text/javascript">
function detectLanguage()
{
    var results = '';
    var code = document.getElementById('code').value;
    var req = new XMLHttpRequest();
    req.open('POST', "/detect", true);
    req.setRequestHeader("Content-type", "text/plain");
    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          var detect_div = document.getElementById('detect_result');
          detect_div.innerText = results;

          data = JSON.parse(results);

          // find the most likely language
          language_name = 'BASIC';
          confidence = 0.0;

          for (var key in data) {
            if (data[key] > confidence) {
              language_name = key;
              confidence = data[key];
            }
          }

          var language_select = document.getElementById('language');
          language_select.value = language_name
        } else {
          console.error(req.statusText);
        }
      }
    };
    req.onerror = function (e) {
      console.error(req.statusText);
    };
    req.send(code);
}

function text_to_safe_html(str) {
  s1 = str.replace(/&/g, '&amp;');
  s2 = s1.replace(/</g, '&lt;');
  s3 = s2.replace(/>/g, '&gt;');
  s4 = s3.replace(/"/g, '&quot;');
  return s4;
}

function tokenize()
{
    html_colors = {
      keyword: 'orchid',
      number: 'blue',
      string: 'salmon',
      operator: 'green',
      comment: 'yellowgreen',
      remark: 'yellowgreen',
      picture: 'hotpink',
      invalid: 'red',
      preprocessor: 'lightgreen'
    };

    var results = '';
    var code = document.getElementById('code').value;
    var language = document.getElementById('language').value;
    var query = "/tokens?language=" + language;
    var req = new XMLHttpRequest();
    req.open('POST', query, true);
    req.setRequestHeader("Content-type", "text/plain");
    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          data = JSON.parse(results)
          formatted_results = '<code><pre>';
          length = data.length;

          for (i = 0; i < length; i++) {
            item = data[i];
            item_type = item['type'];
            item_value = item['value'];
            item_safe = text_to_safe_html(item_value);
            if (item_type == 'newline') {
              formatted_results += '<br/>';
            } else if (item_type in html_colors) {
              front_html = '<font color=' + html_colors[item['type']] + '>';
              back_html = '</font>';
              formatted_results += front_html + item_safe + back_html;
            } else {
              formatted_results += item_safe;
            }
          }

          formatted_results += '</pre></code>'

          var div = document.getElementById('tokens_result');
          div.innerHTML = formatted_results;
        } else {
          console.error(req.statusText);
        }
      }
    };

    req.onerror = function (e) {
      console.error(req.statusText);
    };
    req.send(code);
}
</script>
</head>
<body>
Welcome to the CodeStat page!
<TEXTAREA cols="50" rows="20" id="code"></TEXTAREA>
<br/>
<input type="button" OnClick="detectLanguage();" value="Detect language"/>
<br/>
<select name="language" id="language">
<option>BASIC</option>
<option>COBOL</option>
<option>C</option>
<option>Cpp</option>
<option>Pascal</option>
</select>
<input type="button" OnClick="tokenize();" value="Tokenize"/>
<div id="detect_result"></div>
<div id="confidence_result"></div>
<div id="tokens_result"></div>
</body>
</HTML>
