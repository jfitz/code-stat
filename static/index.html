<HTML>
<head>
<script type="text/javascript">
function keys_in_object(o) {
  keys = [];

  for (key in o) {
    keys.push(key);
  }

  return keys;
}

function longest_string(ss) {
  longest = '';

  for (i = 0; i < ss.length; i++) {
    if (ss[i].length > longest.length) {
      longest = ss[i];
    }
  }

  return longest;
}

function build_confidence_grid(confidences) {
  width = 20
  decimals = 5
  names = keys_in_object(confidences);
  name_length = longest_string(names).length;

  for (i = 0; i < names.length; i++) {
    name = names[i]

    // format the name with trailing spaces
    num_spaces = name_length - name.length + 1;
    spaces = ' '.repeat(num_spaces);
    confidence = confidences[name];

    // format the chart (stars) with trailing spaces
    g_confidence = Math.round(confidence * width);
    g_stars = '*'.repeat(g_confidence);
    g_spaces = ' '.repeat(width - g_confidence);
    g_bar = '  [' + g_stars + g_spaces + ']'

    formatted_results += name + spaces + confidence.toFixed(decimals) + g_bar + '<br/>';
  }

  return formatted_results
}

function detectLanguage() {
    var results = '';
    var code = document.getElementById('code').value;
    var req = new XMLHttpRequest();
    req.open('POST', "/detect", true);
    req.setRequestHeader("Content-type", "text/plain");
    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          confidences = JSON.parse(results);
          names = keys_in_object(confidences);

          // build list of names and confidence values
          names.sort();
          formatted_results = '<code><pre>';
          formatted_results += build_confidence_grid(confidences);
          formatted_results += '</pre></code>';

          var detect_div = document.getElementById('detect_result');
          detect_div.innerHTML = formatted_results;

          if (names.length > 0) {
            // find the most likely language
            language_name = names[0];
            confidence = 0.0;

            for (i = 0; i < names.length; i++) {
              name = names[i];

              if (confidences[name] > confidence) {
                language_name = name;
                confidence = confidences[name];
              }
            }

            var language_select = document.getElementById('language');
            language_select.value = language_name
          }
        } else {
          console.error(req.statusText);
        }
      }
    };
    req.onerror = function (e) {
      console.error(req.statusText);
    };
    req.send(code);
}

function text_to_safe_html(str) {
  s1 = str.replace(/&/g, '&amp;');
  s2 = s1.replace(/</g, '&lt;');
  s3 = s2.replace(/>/g, '&gt;');
  s4 = s3.replace(/"/g, '&quot;');
  return s4;
}

function colorize(token, html_colors) {
  token_type = token['type'];
  token_value = token['value'];
  token_safe = text_to_safe_html(token_value);
  token_html = 'empty';

  if (token_type == 'newline') {
    token_html = '<br/>'; 
  } else if (token_type.startsWith('invalid')) {
    front_html = '<font color=red>';
    back_html = '</font>';
    token_html = front_html + token_safe + back_html;
  } else if (token_type in html_colors) {
    front_html = '<font color=' + html_colors[token_type] + '>';
    back_html = '</font>';
    token_html = front_html + token_safe + back_html;
  } else {
    token_html = token_safe;
  }

  return token_html;
}

function tokenize() {
    html_colors = {
      keyword: 'orchid',
      number: 'blue',
      string: 'salmon',
      operator: 'green',
      comment: 'yellowgreen',
      remark: 'yellowgreen',
      picture: 'hotpink',
      invalid: 'red',
      preprocessor: 'lightgreen',
      'line number': 'skyblue',
      'line identification': 'royalblue',
      'line continuation': 'goldenrod'
    };

    var results = '';
    var code = document.getElementById('code').value;
    var language = document.getElementById('language').value;
    // change 'C++' because the '+' character causes problems for requests
    // TODO: escape the request to allow '+'
    if (language == 'C++') {
      language = 'Cpp';
    }

    var query = "/tokens?language=" + language;
    var req = new XMLHttpRequest();
    req.open('POST', query, true);
    req.setRequestHeader("Content-type", "text/plain");
    req.onload = function (e) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          results = req.responseText;
          data = JSON.parse(results)
          formatted_results = '<code><pre>';
          length = data.length;

          for (i = 0; i < length; i++) {
            formatted_results += colorize(data[i], html_colors)
          }

          formatted_results += '</pre></code>'

          var div = document.getElementById('tokens_result');
          div.innerHTML = formatted_results;
        } else {
          // TODO: build a response
          console.error(req.statusText);
        }
      }
    };

    req.onerror = function (e) {
      // TODO: build a response
      console.error(req.statusText);
    };

    req.send(code);
}
</script>
</head>
<body>
Welcome to the CodeStat page!
<textarea style="width:100%;" rows="20" id="code"></textarea>
<br/>
<input type="button" OnClick="detectLanguage();" value="Detect language"/>
<br/>
<select name="language" id="language">
<option>BASIC</option>
<option>Fixed-Format-COBOL</option>
<option>Free-Format-COBOL</option>
<option>C</option>
<option>C++</option>
<option>Pascal</option>
<option>Python</option>
</select>
<input type="button" OnClick="tokenize();" value="Tokenize"/>
<div id="detect_result" style="border:1px solid black"></div>
<div id="confidence_result" style="border:1px solid black"></div>
<div id="tokens_result" style="border:1px solid black"></div>
</body>
</HTML>
